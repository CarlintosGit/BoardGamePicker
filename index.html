<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Board Game Picker</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet" />
<style>
:root {
  --primary: #00f0ff;
  --secondary: #007c91;
  --text-light: #b0eaff;
}

body.theme-blue {
  --primary: #00f0ff;
  --secondary: #007c91;
  --text-light: #b0eaff;
}

body.theme-red {
  --primary: #cc3333;
  --secondary: #661111;
  --text-light: #ff9999;
}

body.theme-cyberpunk {
  --primary: #fffa00;
  --secondary: #ffaa00;
  --text-light: #fff48f;
}

body.theme-matrix {
  --primary: #008f11;
  --secondary: #003b00;
  --text-light: #33ff55;
}

body.theme-galaxy {
  --primary: #6a0dad;
  --secondary: #0b0033;
  --text-light: #d3bfff;
}

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  font-family: 'Orbitron', sans-serif;
  color: var(--text-light);
  background-color: black;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  overflow-y: auto;
}

body {
  transition: background-image 1s ease-in-out;
}

main {
  position: relative;
  z-index: 1;
  width: 100%;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 0;
  box-sizing: border-box;
  backdrop-filter: brightness(0.4);
}

h1 {
  font-size: 2.5em;
  margin-bottom: 25px;
  text-shadow: 0 0 10px var(--primary);
}

.control-panel {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: rgba(0, 0, 0, 0.6);
  border: 2px solid rgba(0, 255, 255, 0.3);
  box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
  border-radius: 10px;
  padding: 15px 20px;
  margin-bottom: 15px;
  width: 100%;
  max-width: 440px;
}

.control-panel input[type="text"] {
  padding: 10px;
  font-size: 16px;
  width: 100%;
  border-radius: 5px;
  border: 2px solid transparent;
  background-color: #222;
  color: color: var(--text-light);
  box-shadow: 0 0 8px rgba(0, 255, 255, 0.5);
  margin-bottom: 12px;
  box-sizing: border-box;
  transition: border 0.2s ease, box-shadow 0.2s ease;
}

.control-panel input[type="text"]:focus {
  outline: none;
  border: 2px solid var(--primary);
  box-shadow: 0 0 12px var(--primary);
}

.btn-row {
  display: flex;
  gap: 10px;
  width: 100%;
  justify-content: center;
}

.btn-row button {
  flex: 1;
  padding: 10px 16px;
  font-size: 14px;
  cursor: pointer;
  border: none;
  border-radius: 5px;
  background: linear-gradient(145deg, var(--primary), var(--secondary));
  color: white;
  text-shadow: 0 0 5px #000;
  box-shadow: 0 0 12px var(--primary);
  transition: transform 0.2s ease;
  user-select: none;
}

.btn-row button:hover {
  transform: scale(1.05);
}

.btn-row button:disabled {
  opacity: 0.5;
}

.selection-controls {
  display: flex;
  gap: 10px;
  margin-bottom: 12px;
  flex-wrap: wrap;
  justify-content: center;
}

.selection-controls button {
  padding: 6px 12px;
  font-size: 13px;
  cursor: pointer;
  border: none;
  border-radius: 6px;
  background: linear-gradient(145deg, var(--primary), var(--secondary));
  color: white;
  text-shadow: 0 0 3px #000;
  box-shadow: 0 0 8px var(--primary);
  transition: transform 0.2s ease;
}

.selection-controls button:hover {
  transform: scale(1.1);
}

ul {
  list-style: none;
  padding: 0;
  margin-top: 10px;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 8px;
  box-sizing: border-box;
  width: 100%;
  max-width: 90vw;
}

li {
  background-color: rgba(255, 255, 255, 0.08);
  padding: 8px 16px;
  border-radius: 20px;
  color: var(--text-light);
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 0 5px rgba(0, 240, 255, 0.2);
  border: 2px solid var(--primary);
  transition: transform 0.2s ease, background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
  cursor: pointer;
  position: relative;
  user-select: none;
}

li.selected {
  background-color: rgba(0, 255, 255, 0.1);
  box-shadow: 0 0 15px var(--primary), 0 0 30px var(--primary) inset;
  border-color: var(--primary);
  color: var(--text-light);
  font-weight: bold;
}

li.warp {
  animation: warpZoom 0.5s ease-out forwards;
}

@keyframes warpZoom {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.4);
    opacity: 0.7;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

.remove-btn {
  cursor: pointer;
  width: 20px;
  height: 20px;
  background: linear-gradient(145deg, var(--primary), var(--secondary));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 8px var(--primary);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  flex-shrink: 0;
}

.remove-btn:hover {
  transform: scale(1.2);
  box-shadow: 0 0 12px var(--primary);
}


.remove-btn svg {
  width: 12px;
  height: 12px;
  stroke: white;
  stroke-width: 2.5;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.bg-switcher,

.file-controls {
  position: absolute;
  top: 10px;
  display: flex;
  gap: 8px;
  z-index: 2;
}

.bg-switcher {
  right: 10px;
}

.file-controls {
  left: 10px;
}

.bg-switcher button {
  width: 34px;
  height: 34px;
  font-size: 16px;
  cursor: pointer;
  border: none;
  border-radius: 4px;
  background: linear-gradient(145deg, var(--primary), var(--secondary));
  color: white;
  text-shadow: 0 0 5px #000;
  box-shadow: 0 0 10px var(--primary);
  transition: transform 0.2s ease;
  user-select: none;
  padding: 0;
}

.file-controls button {
  width: 34px;
  height: 34px;
  font-size: 12px;
  cursor: pointer;
  border: none;
  border-radius: 4px;
  background: linear-gradient(145deg, var(--primary), var(--secondary));
  color: white;
  text-shadow: 0 0 5px #000;
  box-shadow: 0 0 10px var(--primary);
  transition: transform 0.2s ease;
  user-select: none;
  padding: 0;
}

.bg-switcher button:hover {
  transform: scale(1.15);
}

.file-controls button:hover {
  transform: scale(1.15);
}

.list-controls {
  position: relative;
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  max-width: 440px;
  width: 100%;
  justify-content: center;
}

.custom-dropdown {
  position: relative;
  flex: 1;
}

.dropdown-selected {
  padding: 10px;
  border: 2px solid rgba(0, 255, 255, 0.3);
  border-radius: 20px;
  background-color: rgba(255, 255, 255, 0.08);
  color: var(--text-light);
  text-align: center;
  cursor: pointer;
  transition: 0.3s;
  box-shadow: 0 0 5px rgba(0, 240, 255, 0.2);
}

.dropdown-selected.active {
  background-color: rgba(0, 255, 255, 0.1);
  border-color: var(--primary);
  color: var(--text-light);
  font-weight: bold;
}

#dropdownSelected,
#dropdownSelected * {
  -webkit-user-select: none; /* Safari/Chrome */
  -moz-user-select: none;    /* Firefox */
  -ms-user-select: none;     /* IE/Edge */
  user-select: none;         /* Standard */
  -webkit-touch-callout: none;
  -webkit-user-drag: none;
}

@keyframes dropdownPulse {
  0% {
    box-shadow: 0 0 5px var(--primary);
    background-color: rgba(0, 255, 255, 0.08);
  }
  50% {
    box-shadow: 0 0 15px var(--primary), 0 0 30px var(--primary) inset;
    background-color: rgba(0, 255, 255, 0.12);
  }
  100% {
    box-shadow: 0 0 5px var(--primary);
    background-color: rgba(0, 255, 255, 0.08);
  }
}

.dropdown-options {
  position: absolute;
  top: calc(100% + 6px);
  left: 0;
  right: 0;
  background: rgba(0, 0, 0, 0.9);
  border: 2px solid var(--primary);
  border-radius: 12px;
  max-height: 220px;
  overflow-y: auto;
  box-shadow: 0 0 15px var(--primary);
  z-index: 10;
  padding: 6px;
  display: none;
  opacity: 0;
  transform: scaleY(0.8);
  transform-origin: top center;
  transition: opacity 0.25s ease, transform 0.25s ease;
}


.dropdown-options.active {
  display: block;
  opacity: 1;
  transform: scaleY(1);
  animation: neonPulse 1.5s infinite alternate;
}

.dropdown-options div {
  padding: 8px;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.2s;
  color: var(--text-light);
  text-align: center;
}

.dropdown-options div:hover {
  background: rgba(0, 255, 255, 0.2);
  color: var(--text-light);
  font-weight: bold;
  box-shadow: 0 0 8px var(--primary) inset;
}


@keyframes neonPulse {
  from {
    box-shadow: 0 0 10px var(--primary);
  }
  to {
    box-shadow: 0 0 20px var(--primary), 0 0 40px var(--primary) inset;
  }
}

.list-controls button {
  width: 34px;
  height: 34px;
  font-size: 18px;
  cursor: pointer;
  border: none;
  border-radius: 50%;
  background: linear-gradient(145deg, var(--primary), var(--secondary));
  color: white;
  text-shadow: 0 0 5px #000;
  box-shadow: 0 0 10px var(--primary);
  transition: transform 0.2s ease;
  user-select: none;
}


.list-controls button:hover {
  transform: scale(1.15);
}

.custom-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.6);
  z-index: 999;
  opacity: 1;
  transition: opacity 0.3s ease-out;
}


.custom-modal.closing { 
	opacity:0; 
	}

.custom-modal-content {
  background: rgba(0, 0, 0, 0.8);
  border: 2px solid var(--primary);
  border-radius: 12px;
  padding: 20px;
  color: var(--text-light);
  text-align: center;
  box-shadow: 0 0 15px var(--primary);
  max-width: 320px;
  animation: modalAppear 0.35s ease-out;
}


.custom-modal-content.closing {
  animation: modalDisappear 0.3s ease-out forwards;
}

@keyframes modalAppear {
  0% {
    opacity: 0;
    transform: scale(0.8);
  }
  60% {
    opacity: 1;
    transform: scale(1.05);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes modalDisappear {
  0% {
    opacity: 1;
    transform: scale(1);
  }
  100% {
    opacity: 0;
    transform: scale(0.8);
  }
}

.custom-modal-content input {
  margin-top: 10px;
  width: 100%;
  padding: 8px 10px;
  border-radius: 5px;
  border: 2px solid transparent;
  background-color: #222;
  color: var(--text-light);
  box-sizing: border-box;
  transition: border 0.2s ease, box-shadow 0.2s ease;
}

.custom-modal-content input:focus {
  outline: none;
  border: 2px solid var(--primary);
  box-shadow: 0 0 10px var(--primary);
}

.custom-modal-content button {
  margin-top: 15px;
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  background: linear-gradient(145deg, var(--primary), var(--secondary));
  color: white;
  cursor: pointer;
  box-shadow: 0 0 8px var(--primary);
}

.custom-modal-content button + button {
  margin-left: 10px;
}

.winner-glow {
  animation: neonPulse 1.5s infinite alternate;
  box-shadow: 0 0 15px var(--primary), 0 0 30px var(--primary) inset;
  border-color: var(--primary);
  color: var(--text-light);
  font-weight: bold;
}

.modal-chip-text {
  color: var(--text-light);
  font-family: 'Orbitron', sans-serif;
  font-size: 14px;
  font-weight: normal;
  text-align: center;
  text-shadow: 0 0 5px rgba(0, 240, 255, 0.2);
  margin: 4px 0;
}

.modal-glow {
  animation: neonPulse 1.5s infinite alternate;
  border-color: var(--primary);
  box-shadow: 0 0 15px var(--primary), 0 0 30px var(--primary) inset;
}

.burger-menu {
  position: fixed;
  bottom: 15px;
  right: 15px;
  z-index: 1000;
}

.burger-menu button {
  width: 32px;
  height: 32px;
  font-size: 16px;
  cursor: pointer;
  border: none;
  border-radius: 50%;
  background: linear-gradient(145deg, var(--primary), var(--secondary));
  color: white;
  text-shadow: 0 0 5px #000;
  box-shadow: 0 0 8px var(--primary);
  transition: transform 0.2s ease;
  user-select: none;
}

.burger-menu button:hover {
  transform: scale(1.15);
}

.custom-modal-content ul li {
  cursor: default;
}

.vertical-buttons {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.plus-grid {
  display: grid;
  grid-template-columns: 40px 40px 40px;
  grid-template-rows: 40px 40px 40px;
  gap: 6px;
  justify-items: center;
  align-items: center;
}

.up-btn {
  grid-column: 2;
  grid-row: 1;
}

.about-btn {
  grid-column: 2;
  grid-row: 2;
}

.left-btn {
  grid-column: 1;
  grid-row: 2;
}

.right-btn {
  grid-column: 3;
  grid-row: 2;
}

.down-btn {
  grid-column: 2;
  grid-row: 3;
}

.plus-grid button {
  width: 36px;
  height: 36px;
  font-size: 16px;
  cursor: pointer;
  border: none;
  border-radius: 4px;
  background: linear-gradient(145deg,var(--primary),var(--secondary));
  color: white;
  text-shadow: 0 0 5px #000;
  box-shadow: 0 0 10px var(--primary);
  transition: transform 0.2s ease;
  user-select: none;
}

.plus-grid button:hover {
  transform: scale(1.15);
}

#result {
  transition: opacity 0.5s ease; /* smooth fade */
}

.fade-out {
  opacity: 0;
}

.custom-modal-content button {
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.custom-modal-content button:hover {
  transform: scale(1.15);
  box-shadow: 0 0 12px var(--primary);
}

/* Neon pulse effect for sliders and winners list items */
.chart-slider-fill, .winners-list-item {
  transition: all 0.3s ease;
  animation: neonPulse 2s infinite alternate;
}

@keyframes neonPulse {
  from {
    box-shadow: 0 0 4px var(--primary);
  }
  to {
    box-shadow: 0 0 12px var(--primary), 0 0 24px var(--primary) inset;
  }
}

.achievement-button {
  position: fixed;
  bottom: 15px;
  left: 15px;
  z-index: 1000;
}

.achievement-button button {
  width: 32px;
  height: 32px;
  font-size: 16px;
  cursor: pointer;
  border: none;
  border-radius: 50%;
  background: linear-gradient(145deg, var(--primary), var(--secondary));
  color: white;
  text-shadow: 0 0 5px #000;
  box-shadow: 0 0 8px var(--primary);
  transition: transform 0.2s ease;
  user-select: none;
}

.achievement-button button:hover {
  transform: scale(1.15);
}

@keyframes neonPulseButton {
  0% {
    box-shadow: 0 0 8px var(--primary);
  }
  50% {
    box-shadow: 0 0 20px var(--primary), 0 0 40px var(--primary) inset;
  }
  100% {
    box-shadow: 0 0 8px var(--primary);
  }
}

.achievement-button.pulsing button {
  animation: neonPulseButton 1.5s infinite alternate;
}

</style>
</head>
<body>

<div class="bg-switcher">
  <div class="plus-grid">
    <button class="up-btn" onclick="scrollUp()">‚ñ≤</button>
    <button class="about-btn" onclick="showAboutModal()">?</button>
    <button class="left-btn" onclick="prevBg()">‚üµ</button>
    <button class="right-btn" onclick="nextBg()">‚ü∂</button>
    <button class="down-btn" onclick="scrollDown()">‚ñº</button>
  </div>
</div>

<div class="file-controls">
  <button onclick="importBGG()">BGG</button>
  <button onclick="saveToFile()">Save</button>
  <button onclick="loadFromFile()">Load</button>
  <input type="file" id="fileInput" style="display:none" accept=".txt"/>
</div>

<main>
<h1>Board Game Picker</h1>

<div class="list-controls">
  <div class="custom-dropdown">
    <div id="dropdownSelected" class="dropdown-selected">Select List</div>
    <div id="dropdownOptions" class="dropdown-options"></div>
  </div>
  <button onclick="createList()">+</button>
  <button onclick="deleteList()">√ó</button>
</div>

<div class="control-panel">
  <input type="text" id="gameInput" placeholder="Enter board game name"/>
  <div class="btn-row">
    <button onclick="addGame()">Add Game</button>
    <button id="pickBtn" onclick="pickGame()">Pick a Game!</button>
  </div>
</div>

<div class="selection-controls">
  <button onclick="clearSelection()">Clear Selection</button>
</div>

<div class="burger-menu">
  <button onclick="showBurgerMenu()">‚ò∞</button>
</div>

<div class="achievement-button">
  <button onclick="showAchievements()">
    üèÜ
  </button>
</div>

<ul id="gameList"></ul>
<div id="result"></div>
</main>

<script>
const appStartTime = Date.now();

const achievements = [
  { id: "curious", name: "Curious", unlocked: false, check: state => state.openAboutCount >= 1 },
  { id: "fileExplorer", name: "File Explorer", unlocked: false, check: state => state.saveToFileCount >= 1 },
  { id: "persistentPicker", name: "Persistent Picker", unlocked: false, check: state => state.emptyPickAttempts >= 1 },
  { id: "gettingStarted",  name: "Getting Started", unlocked: false, check: state => state.listCount >= 1},
  { id: "listCollector", name: "List Collector", unlocked: false, check: state => state.listCount >= 5, progress: 0},
  { id: "listMaster", name: "List Master", unlocked: false, check: state => state.listCount >= 10, progress: 0},
  { id: "springCleaning", name: "Spring Cleaning", unlocked: false, check: state => state.listdelCount >= 1},
  { id: "chipReaper", name: "Chip Reaper", unlocked: false, check: state => state.removedGamesCount >= 10, progress: 0},
  { id: "firstPick", name: "First Pick", unlocked: false, check: state => state.totalPicks >= 1, progress: 0},
  { id: "masterGamer", name: "Master Gamer", unlocked: false, check: state => state.totalPicks >= 100, progress: 0},
  { id: "veteranGamer", name: "Veteran Gamer", unlocked: false, check: state => state.totalPicks >= 250, progress: 0},
  { id: "legendaryGamer", name: "Legendary Gamer", unlocked: false, check: state => state.totalPicks >= 1000, progress: 0},
  { id: "bggExplorer", name: "BGG Explorer", unlocked: false, check: state => state.bggCount >= 1},
  { id: "selectionSpecialist", name: "Selection Specialist", unlocked: false, check: state => state.clearSelectCount >= 10, progress: 0},
  { id: "speedDemon", name: "Speed Demon", unlocked: false, check: state => state.speedDemonCount >= 1},  
];

const state = {
  openAboutCount: 0,
  saveToFileCount: 0,
  emptyPickAttempts: 0,
  listCount: 0,
  listdelCount: 0,
  removedGamesCount: 0,
  totalPicks: 0,
  bggCount: 0,
  clearSelectCount: 0,
  speedDemonCount: 0,
};

function checkAchievements() {
  achievements.forEach(a => {
    
	// Handle progress for list-related achievements
    if (["gettingStarted", "listCollector", "listMaster"].includes(a.id)) {
      const thresholds = { gettingStarted: 1, listCollector: 5, listMaster: 10 };
      const target = thresholds[a.id];
      const rawProgress = Math.min(state.listCount / target, 1);
      a.progress = Math.round(rawProgress * 100) / 100;
    }

    // Handle progress for chip removal achievement
    if (a.id === "chipReaper") {
      const target = 10;
      const rawProgress = Math.min(state.removedGamesCount / target, 1);
      a.progress = Math.round(rawProgress * 100) / 100;
    }
	
	// Handle progress for clear selection achievement
    if (a.id === "selectionSpecialist") {
      const target = 10;
      const rawProgress = Math.min(state.clearSelectCount / target, 1);
      a.progress = Math.round(rawProgress * 100) / 100;
    }
	
	if (["firstPick", "masterGamer", "veteranGamer"].includes(a.id)) {
      const thresholds = { firstPick: 1, masterGamer: 100, veteranGamer: 250, legendaryGamer: 1000 };
      const target = thresholds[a.id];
      const rawProgress = Math.min(state.totalPicks / target, 1);
      a.progress = Math.round(rawProgress * 100) / 100;
    }

    // Default progress for others if not set
    if (a.progress === undefined) a.progress = a.unlocked ? 1 : 0;

    // Check if unlocked
    if (!a.unlocked && a.check(state)) {
      a.unlocked = true;
      a.progress = 1;
      glowAndPulseAchievementChip(a.id);
    }
  });
}

function glowAndPulseAchievementChip(id) {
  const container = document.querySelector('.achievement-button');
  const btn = container.querySelector('button');
  if (!btn) return;

  // Add permanent pulsing glow until clicked
  container.classList.add('pulsing');
  console.log(`Achievement unlocked: ${id}`);
}

function showAchievements() {
  const styles = getComputedStyle(document.body);
  const primaryColor = styles.getPropertyValue('--primary').trim() || '#00f0ff';
  const secondaryColor = styles.getPropertyValue('--secondary').trim() || '#007c91';

  // Example structure: each achievement has { name, unlocked, progress } (progress = 0.0‚Äì1.0)
  let itemsHtml = achievements.map(a => {
    const progress = a.unlocked ? 1 : (a.progress ?? 0); // fallback to 0 if missing
    const widthPercent = progress * 100;

    return `
      <div style="margin:8px 0;">
        <div style="
          display:flex;
          align-items:center;
          justify-content:space-between;
          margin-bottom:4px;
        ">
          <div style="
            font-size:14px;
            text-align:left;
            padding-right:8px;
            color:${a.unlocked ? 'var(--text-light)' : 'rgba(180,180,180,0.5)'};
            font-weight:${a.unlocked ? 'bold' : 'normal'};
            text-shadow:${a.unlocked ? `0 0 5px ${primaryColor}, 0 0 10px ${primaryColor}` : 'none'};
            flex:1;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
          ">
            ${a.unlocked ? 'üèÜ' : 'üîí'} ${a.name}
          </div>
          <div style="font-size:12px; width:32px; text-align:right; color:rgba(255,255,255,0.6);">
            ${Math.round(widthPercent)}%
          </div>
        </div>

        <div style="height:8px; background:rgba(255,255,255,0.1); border-radius:6px; overflow:hidden;">
          <div style="
            width:${widthPercent}%;
            height:100%;
            background: linear-gradient(145deg, ${primaryColor}, ${secondaryColor});
            border-radius:6px;
            transition: width 0.3s ease;
            opacity:${a.unlocked ? 1 : 0.6};
            filter:${a.unlocked ? 'drop-shadow(0 0 6px ' + primaryColor + ')' : 'none'};
          "></div>
        </div>
      </div>
    `;
  }).join("");

  const modalContent = `
    <div class="custom-modal-content modal-glow" style="width:400px; max-width:90vw;">
      <div class="modal-chip-text" style="margin-bottom:10px;">
        <strong>Achievements</strong>
      </div>
      ${itemsHtml}
    </div>
  `;

  const modal = document.createElement('div');
  modal.className = 'custom-modal';
  modal.innerHTML = modalContent;
  modal.style.userSelect = "none";
  // Close button
  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'Close';
  closeBtn.style.marginTop = '12px';
  closeBtn.style.padding = '6px 12px';
  closeBtn.style.width = 'auto';
  closeBtn.onclick = () => {
    modal.classList.add('closing');
    modal.querySelector('.custom-modal-content').classList.add('closing');
    modal.querySelector('.custom-modal-content').addEventListener('animationend', () => {
      if (modal.parentNode) document.body.removeChild(modal);
    }, { once: true });
  };

  modal.querySelector('.custom-modal-content').appendChild(closeBtn);
  document.body.appendChild(modal);

  // Stop pulsing once clicked
  document.querySelector('.achievement-button')?.classList.remove('pulsing');
}


// ---------- Theme Switching ----------
const themes = ["theme-blue", "theme-red", "theme-cyberpunk", "theme-matrix", "theme-galaxy"];
let currentThemeIndex = 0;

function applyTheme(index) {
  document.body.classList.remove(...themes);
  currentThemeIndex = (index + themes.length) % themes.length;
  document.body.classList.add(themes[currentThemeIndex]);
  localStorage.setItem("themeIndex", currentThemeIndex);
}

function scrollUp() {
  applyTheme(currentThemeIndex + 1); // cycle forward
}

function scrollDown() {
  applyTheme(currentThemeIndex - 1); // cycle backward
}

window.addEventListener("load", () => {
  const savedTheme = localStorage.getItem("themeIndex");
  applyTheme(savedTheme !== null ? parseInt(savedTheme) : 0);
  // Load last active list from localStorage
	const savedList = localStorage.getItem('activeList');
	if (savedList && allLists[savedList]) {
	  currentList = savedList;
	}
	renderDropdown();
	renderGames();
});


// ---------- Backgrounds ----------
const backgrounds = [
  'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?auto=format&fit=crop&w=1920&q=80',
  'https://images.unsplash.com/photo-1447433819943-74a20887a81e?auto=format&fit=crop&w=1920&q=80',
  'https://images.unsplash.com/photo-1656075027874-35a37a27732b?auto=format&fit=crop&w=1920&q=80',
  'https://images.unsplash.com/photo-1756747646179-d5652667914e?auto=format&fit=crop&w=1920&q=80',
  'https://images.unsplash.com/photo-1677357623576-7c8aab08da22?auto=format&fit=crop&w=1920&q=80'
];
let currentBg = 0;

function setBg(index) {
  const nextIndex = (index + backgrounds.length) % backgrounds.length;
  document.body.style.backgroundImage = `url('${backgrounds[nextIndex]}')`;
  currentBg = nextIndex;
  localStorage.setItem('bgIndex', currentBg);
}

function nextBg() {
  setBg(currentBg + 1);
}
function prevBg() {
  setBg(currentBg - 1);
}
window.addEventListener('load', () => {
  const savedBg = localStorage.getItem('bgIndex');
  setBg(savedBg !== null ? parseInt(savedBg) : 0);
});

// ---------- Lists ----------
let allLists = JSON.parse(localStorage.getItem('BoardGameList')) || { "Default": [] };
let currentList = Object.keys(allLists)[0];
let pendingClearWarningHandler = null;
const selectedIndices = new Set();
function saveLists() {
  localStorage.setItem('BoardGameList', JSON.stringify(allLists));
}

// ---------- Dropdown ----------
function renderDropdown() {
  const dropdownSelected = document.getElementById('dropdownSelected');
  const dropdownOptions = document.getElementById('dropdownOptions');

  dropdownSelected.textContent = currentList;
  dropdownOptions.innerHTML = '';

  Object.keys(allLists).forEach(name => {
    const div = document.createElement('div');
    div.textContent = name;

    div.onclick = () => {
      currentList = name;
      selectedIndices.clear();
      renderGames();
      dropdownSelected.textContent = name;
      closeDropdown();
	  localStorage.setItem('activeList', currentList);
    };

    dropdownOptions.appendChild(div);
  });
}

function toggleDropdown() {
  const dropdownOptions = document.getElementById('dropdownOptions');
  const dropdownSelected = document.getElementById('dropdownSelected');
  const isActive = dropdownOptions.classList.contains('active');

  if (isActive) {
    dropdownOptions.classList.remove('active');
    dropdownSelected.classList.remove('active');
  } else {
    dropdownOptions.classList.add('active');
    dropdownSelected.classList.add('active');
  }
}

function closeDropdown() {
  document.getElementById('dropdownOptions').classList.remove('active');
  document.getElementById('dropdownSelected').classList.remove('active');
}

document.getElementById('dropdownSelected').onclick = toggleDropdown;

document.addEventListener('click', (e) => {
  if (!e.target.closest('.custom-dropdown')) closeDropdown();
});

// Prevent selection on the closed dropdown selected element (JS fallback)
(function() {
  const sel = document.getElementById('dropdownSelected');
  if (!sel) return;

  sel.addEventListener('selectstart', e => e.preventDefault());
  sel.addEventListener('dblclick', e => e.preventDefault());

  sel.addEventListener('mousedown', (e) => {
    setTimeout(() => {
      try { window.getSelection().removeAllRanges(); } catch (err) {}
    }, 0);
  });
})();

// ---------- Games ----------
function renderGames() {

  const list = document.getElementById('gameList');
  list.innerHTML = '';

  const games = allLists[currentList] || [];

  games.forEach((game, index) => {
    const li = document.createElement('li');
    li.textContent = game;

    if (selectedIndices.has(index)) {
      li.classList.add('selected');
    }

    li.onclick = (e) => {
      if (e.target.closest('.remove-btn')) return;

      if (selectedIndices.has(index)) {
        selectedIndices.delete(index);
      } else {
        selectedIndices.add(index);
      }

      renderGames();
    };

    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    `;

    removeBtn.onclick = () => {
      showModal(`Remove "${game}" from the list?`, (confirm) => {
        if (confirm) {
          li.classList.add('warp');
          setTimeout(() => {
            allLists[currentList].splice(index, 1);
            selectedIndices.delete(index);
            saveLists();
            renderGames();
			state.removedGamesCount++;
            checkAchievements();
          }, 500);
        }
      }, true);
    };
    li.appendChild(removeBtn);
    list.appendChild(li);
  });
}


function addGame() {
  const input = document.getElementById('gameInput');
  const game = input.value.trim();

  if (game) {
    if (allLists[currentList].some(g => g.toLowerCase() === game.toLowerCase())) {
      showModal(`"${game}" already exists in the list.`);
      input.value = '';
      return;
    }

    allLists[currentList].push(game);
    input.value = '';
    saveLists();
    renderGames();
  }
}

document.getElementById('gameInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') addGame();
});


function clearSelection() {
  selectedIndices.clear();
  renderGames();
  state.clearSelectCount++;
  checkAchievements();
}

function clearPreviousGlow() {
  document.querySelectorAll('.winner-glow').forEach(el => 
    el.classList.remove('winner-glow')
  );
}

// ---------- Pick Game ----------
function pickGame() {
  clearPreviousGlow();

  const pickBtn = document.getElementById('pickBtn');
  pickBtn.disabled = true;
  pickBtn.textContent = "Picking...";

  const result = document.getElementById('result');
  const games = allLists[currentList] || [];

  // --- empty-list case: show warning and install a click-to-clear handler ---
  if (games.length === 0) {
	state.emptyPickAttempts++;
	checkAchievements();
	
	result.textContent = "No games in list!";
	result.classList.remove('fade-out');

	if (!pendingClearWarningHandler) {
	  pendingClearWarningHandler = function handler(e) {
		if (e && e.target && e.target.closest && e.target.closest('#pickBtn')) {
		  return;
		}
		// fade out first
		result.classList.add('fade-out');
		setTimeout(() => { result.textContent = ""; result.classList.remove('fade-out'); }, 500);

		document.removeEventListener('click', pendingClearWarningHandler);
		pendingClearWarningHandler = null;
	  };

	  setTimeout(() => {
		document.addEventListener('click', pendingClearWarningHandler);
	  }, 0);
	}	

    pickBtn.disabled = false;
    pickBtn.textContent = "Pick a Game!";
    return;
  }

  // --- normal pick flow ---
  let candidates = [...selectedIndices].map(i => games[i]);
  if (candidates.length === 0) candidates = games;

  state.totalPicks++;

  // --- Check speed demon ---
  const now = Date.now();
  const elapsedSeconds = (now - appStartTime) / 1000;

  if (!achievements.find(a => a.id === "speedDemon").unlocked && elapsedSeconds <= 3) {
    state.speedDemonCount++;
  }

  checkAchievements();

  let counter = 0,
      previousLi = null;

  const interval = setInterval(() => {
    const randomGame = candidates[Math.floor(Math.random() * candidates.length)];
    const listItems = document.querySelectorAll('#gameList li');

    if (previousLi) previousLi.classList.remove('warp');

    const winnerIndex = games.indexOf(randomGame);
    if (winnerIndex >= 0) {
      const currentLi = listItems[winnerIndex];
      currentLi.classList.add('warp');
      previousLi = currentLi;
    }

    counter++;

    if (counter > 15) {
      clearInterval(interval);
      if (previousLi) previousLi.classList.remove('warp');
      const winnerLi = listItems[games.indexOf(randomGame)];
      if (winnerLi) {
        winnerLi.classList.add('warp', 'winner-glow');
        setTimeout(() => winnerLi.classList.remove('warp'), 500);

		// ---- SAVE WINNER HISTORY (count-only, per-list) ----
		const counts = getWinnersCounts(currentList);
		counts[randomGame] = (counts[randomGame] || 0) + 1;
		saveWinnersCounts(counts, currentList);
      }
      pickBtn.disabled = false;
      pickBtn.textContent = "Pick a Game!";
    }
  }, 120);
}

// ---------- Modal ----------
function closeModal(modal) {
  modal.classList.add('closing');

  const content = modal.querySelector('.custom-modal-content');
  content.classList.add('closing');

  content.addEventListener('animationend', () => {
    if (modal.parentNode) {
      document.body.removeChild(modal);
    }
  }, { once: true });
}

function showModal(message, callback = null, confirmMode = false, placeholder = "") {
  const modal = document.createElement('div');
  modal.className = 'custom-modal';

  const content = document.createElement('div');
  content.className = 'custom-modal-content';
  content.innerHTML = `<p>${message}</p>`;

  if (confirmMode) {
    const yesBtn = document.createElement('button');
    yesBtn.textContent = "Yes";
    yesBtn.onclick = () => {
      closeModal(modal);
      callback(true);
    };

    const noBtn = document.createElement('button');
    noBtn.textContent = "No";
    noBtn.onclick = () => {
      closeModal(modal);
      callback(false);
    };

    content.appendChild(yesBtn);
    content.appendChild(noBtn);

  } else if (callback) {
    const input = document.createElement('input');
    input.type = 'text';
    if (placeholder) input.placeholder = placeholder;
    content.appendChild(input);

    const okBtn = document.createElement('button');
    okBtn.textContent = 'OK';
    okBtn.onclick = () => {
      closeModal(modal);
      callback(input.value.trim(), input);
    };
    content.appendChild(okBtn);

    setTimeout(() => input.focus(), 0);
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') okBtn.click();
    });

  } else {
    const okBtn = document.createElement('button');
    okBtn.textContent = 'OK';
    okBtn.onclick = () => {
      closeModal(modal);
    };
    content.appendChild(okBtn);
  }

  modal.appendChild(content);
  document.body.appendChild(modal);
}

// ---------- Winners history helpers (per-list, with migration) ----------
function getAllWinnersHistory() {
  const raw = localStorage.getItem('winnersHistory');
  if (!raw) return {};

  try {
    const parsed = JSON.parse(raw);

    // If legacy array (["Game - timestamp", ...]) convert -> { currentList: { name: count } }
    if (Array.isArray(parsed)) {
      const counts = {};
      parsed.forEach(entry => {
        const name = (typeof entry === 'string') ? entry.split(' - ')[0].trim() : String(entry);
        if (!name) return;
        counts[name] = (counts[name] || 0) + 1;
      });
      const wrapped = {};
      wrapped[currentList] = counts;
      localStorage.setItem('winnersHistory', JSON.stringify(wrapped));
      return wrapped;
    }

    // If parsed is an object, detect whether it's old flat format (name -> number)
    if (parsed && typeof parsed === 'object') {
      const firstVal = parsed[Object.keys(parsed)[0]];
      // If values are numbers -> old flat counts format, wrap under currentList
      if (typeof firstVal === 'number') {
        const wrapped = {};
        wrapped[currentList] = parsed;
        localStorage.setItem('winnersHistory', JSON.stringify(wrapped));
        return wrapped;
      }

      // Otherwise assume it's already per-list format { listName: { name: count, ... }, ... }
      return parsed;
    }
  } catch (e) {
    console.error('Failed to parse winnersHistory:', e);
  }

  return {};
}

function getWinnersCounts(listName = currentList) {
  const all = getAllWinnersHistory();
  // return a shallow clone to avoid accidental mutation outside
  return all[listName] ? Object.assign({}, all[listName]) : {};
}

function saveWinnersCounts(counts, listName = currentList) {
  const all = getAllWinnersHistory();
  all[listName] = counts || {};
  localStorage.setItem('winnersHistory', JSON.stringify(all));
}


// ---------- Game History (counts) ----------
function showBurgerMenu() {
  const counts = getWinnersCounts(currentList);
  const entries = Object.entries(counts || {});
  let listHtml = "";

  if (entries.length > 0) {
    // sort by count desc, then take only top 10
    entries.sort((a, b) => b[1] - a[1]);
    const topEntries = entries.slice(0, 10);

    listHtml = "<ul style='list-style:none; padding:0; margin:10px 0;'>";
    topEntries.forEach(([name, count]) => {
      listHtml += `
        <li style="
          display:block;
          width:100%;
          margin:6px 0;
          padding:6px 0;
          color:var(--text-light);
          font-size:15px;
          text-align:center;
          border-bottom:1px solid rgba(255,255,255,0.15);
          white-space:normal;
          word-break:break-word;
        ">
          ${name} ‚Äî ${count}
        </li>`;
    });
    listHtml += "</ul>";
  } else {
    listHtml = `<div class="modal-chip-text">No winners yet for "${currentList}".</div>`;
  }

  const modalContent = `
    <div class="custom-modal-content modal-glow">
      <div class="modal-chip-text"><strong>Winners History (Top 10) ‚Äî ${currentList}</strong></div>
      ${listHtml}
    </div>
  `;

  const modal = document.createElement('div');
  modal.className = 'custom-modal';
  modal.innerHTML = modalContent;

  // ---- Buttons ----
  const buttonContainer = document.createElement('div');
  buttonContainer.style.display = 'flex';
  buttonContainer.style.justifyContent = 'center';
  buttonContainer.style.gap = '10px';
  buttonContainer.style.marginTop = '15px';

  // Chart button
  const chartBtn = document.createElement('button');
  chartBtn.textContent = 'Chart';
  chartBtn.onclick = () => {
    showWinnersChart(currentList); // define this separately
  };

  // Close button
  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'Close';
  closeBtn.onclick = () => {
    modal.classList.add('closing');
    modal.querySelector('.custom-modal-content').classList.add('closing');
    modal.querySelector('.custom-modal-content').addEventListener('animationend', () => {
      if (modal.parentNode) document.body.removeChild(modal);
    }, { once: true });
  };

  // Clear button ‚Äî clears ONLY the current list‚Äôs history
  const clearBtn = document.createElement('button');
  clearBtn.textContent = 'Clear History';
  clearBtn.onclick = () => {
    const all = getAllWinnersHistory() || {};
    if (all[currentList]) {
      delete all[currentList]; // remove only the currently selected list
      localStorage.setItem('winnersHistory', JSON.stringify(all));
    }
    modal.classList.add('closing');
    modal.querySelector('.custom-modal-content').classList.add('closing');
    modal.querySelector('.custom-modal-content').addEventListener('animationend', () => {
      if (modal.parentNode) document.body.removeChild(modal);
    }, { once: true });
  };

  // append buttons
  buttonContainer.appendChild(chartBtn);
  buttonContainer.appendChild(closeBtn);
  buttonContainer.appendChild(clearBtn);

  modal.querySelector('.custom-modal-content').appendChild(buttonContainer);
  document.body.appendChild(modal);
}


// ---------- WINNERS CHART ----------
function showWinnersChart(listName) {
  const counts = getWinnersCounts(listName) || {};
  const entries = Object.entries(counts);

	if (entries.length === 0) {
	  showModal(`No data for "${listName}" yet!`);
	  return;
	}

  // Sort descending by count
  entries.sort((a, b) => b[1] - a[1]);
  const maxCount = entries[0][1];

  // Get theme's primary and secondary colors
  const styles = getComputedStyle(document.body);
  const primaryColor = styles.getPropertyValue('--primary').trim() || '#00f0ff';
  const secondaryColor = styles.getPropertyValue('--secondary').trim() || '#007c91';

  // Build sliders with gradient
  const slidersHtml = entries.map(([name, count]) => {
    const widthPercent = (count / maxCount) * 100; // relative width
    return `
      <div style="display:flex; align-items:center; margin:6px 0;">
        <div style="width:150px; font-size:14px; text-align:left; padding-right:10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
          ${name}:
        </div>
        <div style="flex-grow:1; height:16px; background: rgba(255,255,255,0.1); border-radius:8px; overflow:hidden;">
          <div style="
            width:${widthPercent}%;
            height:100%;
            background: linear-gradient(145deg, ${primaryColor}, ${secondaryColor});
            border-radius:8px;
            transition: width 0.3s ease;
          "></div>
        </div>
        <div style="width:40px; text-align:right; font-size:14px; padding-left:8px;">
          ${count}
        </div>
      </div>
    `;
  }).join('');

  const modalContent = `
    <div class="custom-modal-content modal-glow" style="width:400px; max-width:90vw;">
      <div class="modal-chip-text" style="margin-bottom:10px;"><strong>Stats ‚Äî ${listName}</strong></div>
      ${slidersHtml}
    </div>
  `;

  const modal = document.createElement('div');
  modal.className = 'custom-modal';
  modal.innerHTML = modalContent;
  modal.style.userSelect = "none";

	// Close button
	const closeBtn = document.createElement('button');
	closeBtn.textContent = 'Close';
	closeBtn.style.marginTop = '12px';
	closeBtn.style.padding = '6px 12px';  // smaller padding
	closeBtn.style.width = 'auto';        // don't stretch full width
	closeBtn.onclick = () => {
	  modal.classList.add('closing');
	  modal.querySelector('.custom-modal-content').classList.add('closing');
	  modal.querySelector('.custom-modal-content').addEventListener('animationend', () => {
		if (modal.parentNode) document.body.removeChild(modal);
	  }, { once: true });
	};

  modal.querySelector('.custom-modal-content').appendChild(closeBtn);
  document.body.appendChild(modal);
}

// ---------- Create/Delete List ----------
function createList() {
  showModal(
    "Enter new list name:",
    (name, inputElement) => {
      if (name && !allLists[name]) {
        
        // üîπ Remove "Default" if it's the only existing list
        if (Object.keys(allLists).length === 1 && allLists["Default"]) {
          delete allLists["Default"];
        }

        allLists[name] = [];
        currentList = name;
        saveLists();
        renderDropdown();
        renderGames();
		localStorage.setItem('activeList', currentList);
		
		state.listCount++;
        checkAchievements();
      }
    },
    false,
    "Enter list name"
  );
}


function deleteList() {
  if (Object.keys(allLists).length === 1) {
    showModal("At least one list is required.");
    return;
  }

  showModal(
    `Delete list "${currentList}"?`,
    (confirm) => {
      if (confirm) {
		  // Remove list data
		  delete allLists[currentList];

		  // Remove winners history for that list (if present)
		  const all = getAllWinnersHistory();
		  if (all && all[currentList]) {
			delete all[currentList];
			localStorage.setItem('winnersHistory', JSON.stringify(all));
		  }

		  currentList = Object.keys(allLists)[0];
		  saveLists();
		  renderDropdown();
		  renderGames();
		  localStorage.setItem('activeList', currentList);
		  
		  state.listdelCount++;
		  state.listCount = Math.max(0, state.listCount - 1);
          checkAchievements();
		}
    },
    true
  );
}

// ---------- About Modal ----------
function showAboutModal() {
  const modalContent = `
    <div class="custom-modal-content modal-glow">
      <div class="modal-chip-text"><strong>Board Game Picker</strong></div>
      <div class="modal-chip-text">Pick a random game from your custom lists!</div>
      <div class="modal-chip-text">Version 1.0</div>
      <div class="modal-chip-text">by Szappanos G√°bor</div>
    </div>
  `;
  const modal = document.createElement('div');
  modal.className = 'custom-modal';
  modal.innerHTML = modalContent;
  modal.style.userSelect = "none";

  const okBtn = document.createElement('button');
  okBtn.textContent = 'OK';
  okBtn.onclick = () => {
    modal.classList.add('closing');
    const content = modal.querySelector('.custom-modal-content');
    content.classList.add('closing');
    content.addEventListener('animationend', () => {
      if (modal.parentNode) {
        document.body.removeChild(modal);
      }
    }, { once: true });
  };

  modal.querySelector('.custom-modal-content').appendChild(okBtn);
  document.body.appendChild(modal);
  
  state.openAboutCount++;
  checkAchievements();
}

// ---------- Import from BGG (All Owned optional, only OWN games) ----------
async function importBGG() {
  showModal(
    "Enter your BGG username:",
    async (username, inputElement) => {
      if (!username) return;

      // Check the checkbox value
      const allOwnedCheckbox = document.getElementById('allOwnedCheckbox');
      const allOwned = allOwnedCheckbox ? allOwnedCheckbox.checked : false;

      // Create a fetching modal
      const fetchingModal = document.createElement('div');
      fetchingModal.className = 'custom-modal';
      fetchingModal.innerHTML = `
        <div class="custom-modal-content modal-glow">
          <div class="modal-chip-text">Fetching your BGG collection... please wait.</div>
        </div>
      `;
      document.body.appendChild(fetchingModal);

      function closeModalAndWait(modal) {
        return new Promise((resolve) => {
          if (!modal) return resolve();
          modal.classList.add('closing');
          const content = modal.querySelector('.custom-modal-content');
          if (content) content.classList.add('closing');

          const cleanup = () => {
            if (modal.parentNode) modal.parentNode.removeChild(modal);
            resolve();
          };

          if (content) {
            content.addEventListener('animationend', cleanup, { once: true });
            setTimeout(cleanup, 700);
          } else {
            cleanup();
          }
        });
      }

      try {
        async function fetchCollection(retries = 12) {
          const response = await fetch(
            `https://boardgamegeek.com/xmlapi2/collection?username=${encodeURIComponent(username)}`
          );

          if (!response.ok) throw new Error("Network error");

          const xmlText = await response.text();
          const parser = new DOMParser();
          const xml = parser.parseFromString(xmlText, "application/xml");

          const messageNode = xml.querySelector("message");
          if (messageNode) {
            if (retries > 0) {
              await new Promise(res => setTimeout(res, 2000));
              return fetchCollection(retries - 1);
            } else {
              throw new Error("BGG collection still not ready. Try again later.");
            }
          }

          return xml;
        }

        const xml = await fetchCollection();

        const items = xml.querySelectorAll("item");
        const games = [];

        items.forEach(item => {
          const statusEl = item.querySelector("status");
          if (!statusEl) return;

          // Always require OWN = 1
          if (statusEl.getAttribute("own") !== "1") return;

          // If All Owned is NOT checked, require numplays > 0
          if (!allOwned) {
            const playsEl = item.querySelector("numplays");
            const numPlays = playsEl ? parseInt(playsEl.textContent.trim(), 10) || 0 : 0;
            if (numPlays <= 0) return;
          }

          const nameEl = item.querySelector("name");
          if (!nameEl) return;

          const gameName = nameEl.textContent.trim();
          if (gameName) games.push(gameName);
        });

        await closeModalAndWait(fetchingModal);

        if (games.length === 0) {
          showModal(`No games found for user "${username}".`);
          return;
        }
        const newListName = `${username}'s BGG Games`;
        allLists[newListName] = games;
        currentList = newListName;
        saveLists();
        renderDropdown();
        renderGames();

        showModal(`Imported ${games.length} games from "${username}".`);
		
		state.bggCount++;
    	checkAchievements();

      } catch (err) {
        console.error(err);
        await closeModalAndWait(fetchingModal);
        showModal("Failed to import BGG collection. Try again later.");
      }
    },
    false,
    "BGG Username"
  );

// Add the checkbox dynamically after modal creation
setTimeout(() => {
  const modalContent = document.querySelector('.custom-modal-content:last-child');
  if (modalContent) {
    // Wrap checkbox + text in a label for proper alignment
    const checkboxWrapper = document.createElement('div');
    checkboxWrapper.style.marginTop = "8px";
    checkboxWrapper.style.display = "inline-block";
    checkboxWrapper.style.width = "auto";
    checkboxWrapper.style.whiteSpace = "nowrap";

    // Use current theme colors for label text and checkbox border
    checkboxWrapper.innerHTML = `
      <label style="display:inline-flex; align-items:center; gap:10px; cursor:pointer; color: var(--text-light);">
        <input type="checkbox" id="allOwnedCheckbox" 
                style="accent-color: var(--primary); width:16px; height:16px; vertical-align:middle; margin-top:3px;" />
        <span style="font-size:14px; line-height:1; user-select:none;">All Owned</span>
      </label>
    `;

    modalContent.insertBefore(checkboxWrapper, modalContent.querySelector('button'));

    // Force OK button on its own line and center it
    const okButton = modalContent.querySelector('button');
    if (okButton) {
      okButton.style.display = "block";        // new line
      okButton.style.marginTop = "12px";       // spacing from checkbox
      okButton.style.marginLeft = "auto";      // center horizontally
      okButton.style.marginRight = "auto";     // center horizontally
    }
  }
}, 0);
}

// ---------- File Save/Load ----------
function saveToFile() {
  let content = '';

  for (const [listName, games] of Object.entries(allLists)) {
    content += `[${listName}]\n`;
    games.forEach(g => content += g + '\n');
    content += '\n';
  }

  const blob = new Blob([content], { type: 'text/plain' });
  const link = document.createElement('a');
  link.download = `BoardGameList.txt`;
  link.href = URL.createObjectURL(blob);
  link.click();
  URL.revokeObjectURL(link.href);
  
  state.saveToFileCount++;
  checkAchievements();
}

function loadFromFile() {
  const fileInput = document.getElementById('fileInput');

  fileInput.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
      const text = ev.target.result;
      const lines = text.split(/\r?\n/);
      const loadedLists = {};
      let currentListName = null;

      lines.forEach(line => {
        line = line.trim();
        if (!line) return;

        const match = line.match(/^\[(.+)\]$/);
        if (match) {
          currentListName = match[1];
          loadedLists[currentListName] = [];
        } else if (currentListName) {
          loadedLists[currentListName].push(line);
        }
      });

      if (Object.keys(loadedLists).length > 0) {
        allLists = loadedLists;
        currentList = Object.keys(allLists)[0];
        selectedIndices.clear();
        saveLists();
        renderDropdown();
        renderGames();
      } else {
        alert("No valid lists found in file.");
      }
    };

    reader.readAsText(file);
  };

  fileInput.click();
}

renderDropdown(); renderGames();
</script>
</body>
</html>
